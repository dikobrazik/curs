<div class="container">

        <%- include('../layouts/nav.ejs') %>
        <div class="col-md-8 d-inline-block mr-1 mt-4 pb-2 float-right bg-light border border-primary">
          <!--<%- include('lessonAddBlock.ejs') %>-->
          <div class="row">
          </div>
          <div class="row">
          </div>
            <!-- Modal -->
            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <footer class="footer fixed-bottom bg-dark">
              <div class="container">
                  <span class="text-muted">Place sticky footer content here.</span>
              </div>
        </footer>
    </div>
    <script>
      var $ = jQuery.noConflict();
      var trdata = [];
      var week = ['Понедельник','Вторник','Среда','Четверг','Пятница','Суббота'];

      $(document).on('click', 'button[data-toggle="modal"]', function (event) {
        var button = $(event.target);
        //table name
        $('.modal-title').text(button.parents('#table').find('thead tr th').text());
        //row index
        console.log(button.parents('tr')["0"].rowIndex);
      });

      //обновление при открытии
      $(document).ready(function(){
        week.forEach(function(item, i){
          if(i<3){
            $('div.row:eq(0)').append('<table class="table form-group col m-2" id="table"><thead><tr><th  class="float-center" scope="col">'+item+'</th></tr></thead><tbody>'+tds()+'</tbody></table>')
          }
          else{
            $('div.row:eq(1)').append('<table class="table form-group col m-2" id="table"><thead><tr><th  class="float-center" scope="col">'+item+'</th></tr></thead><tbody>'+tds()+'</tbody></table>')
          }

        });
      });
      function tds(){
        var tds = '';
        for(let i=0; i < 6; i++){
          tds+='<tr class="d-flex justify-content-center"><td class="col p-0"><button type="button" class="col btn btn-success" data-toggle="modal" data-target="#exampleModal"><i class="fas fa-plus"></i></button><td></tr>';
        }
        return tds;
      };
      /*
      * функция обновления
      * Очищает таблицу
      * загружает список с сервера
      * вносит данные в таблицу
      */
      function refresh(){
        $('.table').hide();
        $("#table tbody tr").remove();
        let tbody;
        let lastNumber = 0;
        $.get( "/user/list", function( data, err ) {
            data.forEach(function(item){
                tbody = tbody + '<tr>' +
                '<th>'+ lastNumber++ +'</th>' +
                '<td>'+item.name+'</td>' +
                '<td>'+item.surname+'</td>' +
                '<td>'+item.username+'</td>' +
                '<td><span class="btn btn-secondary edit pull-center"><i class="fas fa-edit"></i></span><span class="btn btn-danger minus pull-center"><i class="fas fa-trash-alt"></i></span></td>' +
              '</tr>';
              
            });
            $('.table').append(tbody);
        });
        $('.table').fadeIn(10);
        $("#name").val('');
        $("#surname").val('');
        $("#username").val('');
        $("#password").val('');
      };
      // on - так как элемент динамически создан и обычный обработчик с ним не работает
      $(document).on('click', '.minus', function(){
        let name = $(this).parent().parent().find('td:eq(0)').html();
        let surname = $(this).parent().parent().find('td:eq(1)').html();
        let username = $(this).parent().parent().find('td:eq(2)').html();
        $.get("/csrfToken", function (data, jwres) {
            if (jwres != 'success') { return false; }
            msg = {
              data: 
                {name:name,
                surname:surname,
                username:username,
                },
              _csrf: data._csrf
            };
            $.post("/user/delete", msg, function(data, status){
                if(status=='success'){
                    refresh();
                }else{
                    alert(status);
                }
            });
        });
      });
      /*
      * Добавляет данные в соответствующие поля для изменения
      */
      $(document).on('click', '.edit', function(){
        trdata[0] = $(this).parent().parent().find('td:eq(0)').html();
        trdata[1] = $(this).parent().parent().find('td:eq(1)').html();
        trdata[2] = $(this).parent().parent().find('td:eq(2)').html();
        $("#name").val(trdata[0]);
        $("#surname").val(trdata[1]);
        $("#username").val(trdata[2]);
      });
      /*
      * Отправляет данные на сервер
      */
      $(document).on('click', '.submit', function(){
        $.get("/csrfToken", function (data, jwres) {
            if (jwres != 'success') { return false; }
            msg = {
                data: 
                    {name:trdata[0],
                    surname:trdata[1],
                    username:trdata[2],
                    },
                ndata: 
                    {name:$("#name").val(),
                    surname:$("#surname").val(),
                    username:$("#username").val(),
                    password:$("#password").val(),
                    },
                _csrf: 
                    data._csrf
            };
            $.post("/user/update", msg, function(data, status){
                if(status=='success'){
                    refresh();
                }else{
                    alert(status);
                }
            });
        });
      });

      $('.plus').click(function(){
         $.get("/csrfToken", function (data, jwres) {
            if (jwres != 'success') { return false; }
            msg = {
              data: 
                {name:$('#name').val(),
                surname:$('#surname').val(),
                username:$('#username').val(),
                password:$('#password').val()},
              _csrf: data._csrf
            };
            $.post("/user/create", msg, function(data, status){
                if(status=='success'){
                    refresh();
                }else{
                    alert(status);
                }
            });
          });
      });
</script>
