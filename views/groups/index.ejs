<div class="container">
    <%- include('../layouts/nav.ejs') %>

    <div class="col-md-8 d-inline-block mr-1 mt-4 pb-2 float-right bg-light border border-primary">
      <%- include('groupAddTab.ejs') %>
    </div>
    <footer class="footer fixed-bottom bg-dark">
          <div class="container">
              <span class="text-muted">Place sticky footer content here.</span>
          </div>
    </footer>
</div>
<script>
  var $ = jQuery.noConflict();
  var groups;

  $(document).ready(function(){
    $.get( "/groups/list", function( data, err ) {
      groups = data;
      data.forEach(function(item, i){
        $('#gNum').append('<option>'+item+'</option>');
      });
    });
  });

  // формируем новые поля
  $('.plus').click(function(){
    let lastNumber;
    if($('#table tbody tr').length == 0) lastNumber = 0;
    else lastNumber = parseInt($('#table').find('tbody').find('th').last().text())+1;
    $('.table').append(
      '<tr>' +
        '<th>'+ lastNumber +'</th>' +
        '<td>'+$("#name").val()+'</td>' +
        '<td>'+$("#surname").val()+'</td>' +
        '<td>'+$("#studentID").val()+'</td>' +
        '<td><span class="btn btn-danger minus pull-center">&ndash;</span></td>' +
      '</tr>'
      );
      $("#name").val('');
      $("#surname").val('');
      $("#studentID").val('');
  });

  $('#gNum').change(function(){
    $("#table tbody tr").remove();
    let table;
    let lastNumber = 0;
    groups.find(function(item, i){
      if(item.gNum==$('#gNum').val()) table = JSON.parse(item.content);
    });
    table.forEach(function(item){
      $('.table').append(
      '<tr>' +
        '<th>'+ lastNumber++ +'</th>' +
        '<td>'+item.name+'</td>' +
        '<td>'+item.surname+'</td>' +
        '<td>'+item.studentID+'</td>' +
        '<td><span class="btn btn-danger minus pull-center">&ndash;</span></td>' +
      '</tr>'
      );
    });
  });
  $("#createGroup").change(function(){
    $('#gNumInput').removeClass('d-none');
    $('#gNum').addClass('d-none');
  });
  $("#upgradeGroup").change(function(){
    $('#gNum').removeClass('d-none');
    $('#gNumInput').addClass('d-none');
  });
  // on - так как элемент динамически создан и обычный обработчик с ним не работает
  $(document).on('click', '.minus', function(){
    $( this ).closest( 'tr' ).remove(); // удаление строки с полями
  });
  $(document).on('click', '.btn-secondary', function(){
    alert('lol'); // удаление строки с полями
  });

  $(function () {
    $('[data-toggle="popover"]').popover();
    $('.popover-dismiss').popover({
      trigger: 'focus'
    });
  });
  
  $('.send-json').click(function(){
    var content = [];
    $("#table tbody tr").each(function(){
          content.push({
            name:this.cells[1].innerText,
            surname:this.cells[2].innerText,
            studentID:this.cells[3].innerText,
          });
      });
     $.get("/csrfToken", function (data, jwres) {
        if (jwres != 'success') { return false; }
        msg = {
          some_data: {gNum:$("#gNum").val(), content:JSON.stringify(content)},
          _csrf: data._csrf
        };
        $.post("/groups/create", msg, function(data, status){});
      });
  });
</script>
